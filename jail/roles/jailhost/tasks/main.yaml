---
- name: Install ezjail
  pkgng: name=ezjail state=present
- name: Fetch portsnap repo
  command: portsnap fetch extract --interactive creates="/usr/ports/INDEX-*"
- name: Check to see if ports tree needs updated
  find: paths="/usr/ports" pattern="INDEX-*" age=1d
  register: localhost_ports_age
- name: Update portsnap
  command: portsnap update --interactive
  when: localhost_ports_age.matched > 0
- name: Enable ezjail in rc.conf
  lineinfile: dest=/etc/rc.conf regexp="ezjail_enable" line="ezjail_enable=\"YES\""
- name: Create basejail
  shell: ezjail-admin install -P creates=/usr/jails/basejail
- name: Create nginx jail
  shell: ezjail-admin create nginx 192.168.166.92 creates=/usr/jails/nginx
- name: Update default router in nginx jail
  lineinfile: dest=/usr/jails/nginx/etc/rc.conf state=present create=yes regexp="default_router" line="default_router=192.168.166.1"
  notify: restart nginx jail
- name: Install resolv.conf into the nginx jail
  copy: src=/etc/resolv.conf dest=/usr/jails/nginx/etc/resolv.conf
  notify: restart nginx jail
- meta: flush_handlers
- name: Install python in nginx jail
  shell: pkg -j nginx install -y python creates=/usr/jails/nginx/usr/local/bin/python
